<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataVault Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <header class="sidebar-header">
                <h1>üöÄ DataVault Assistant</h1>
                <p class="subtitle">AI-Powered Data Vault 2.1 Model Generator</p>
            </header>

            <div class="config-status" id="configStatus">
                <div class="status-item">
                    <span class="status-label">OCR API:</span>
                    <span class="status-value" id="ocrStatus">‚è≥ Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">GROQ API:</span>
                    <span class="status-value" id="groqStatus">‚è≥ Checking...</span>
                </div>
            </div>

            <section class="section">
                <h2>üìö 1. Knowledge Base (Optional)</h2>
                <p class="help-text">Upload DV2.1 methodology for grounded generation</p>
                <input type="file" id="knowledgeFile" accept=".txt,.md,.pdf">
                <button onclick="uploadKnowledge()" class="btn btn-secondary">
                    Upload Methodology
                </button>
                <div id="knowledgeStatus"></div>
            </section>

            <section class="section">
                <h2>üñºÔ∏è 2. Upload Source Model</h2>
                <p class="help-text">Option A: Upload ERD image or PDF</p>
                <input type="file" id="sourceFile" accept="image/*,.pdf">
                <button onclick="uploadSource()" class="btn btn-primary" id="uploadBtn">
                    Extract Schema (OCR)
                </button>
                
                <p class="help-text" style="margin-top: 16px;">Option B: Enter schema manually</p>
                <textarea id="manualSchema" placeholder="Enter your schema here:&#10;&#10;Table: customers&#10;Columns: id (PK), name, email&#10;&#10;Table: orders&#10;Columns: id (PK), customer_id (FK -> customers.id), order_date, amount&#10;&#10;Table: products&#10;Columns: id (PK), name, price" style="width: 100%; height: 120px; padding: 10px; border: 1px solid #d1d5da; border-radius: 6px; font-size: 13px; font-family: monospace; margin-bottom: 12px;"></textarea>
                <button onclick="submitManualSchema()" class="btn btn-primary" id="manualBtn">
                    Use Manual Schema
                </button>
                
                <div id="uploadStatus"></div>
                
                <!-- OCR Preview Modal -->
                <div id="ocrPreviewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; padding: 40px;">
                    <div style="background: white; border-radius: 8px; max-width: 800px; margin: 0 auto; height: calc(100% - 80px); display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid #e1e4e8;">
                            <h2 style="margin: 0;">üìÑ OCR Extraction Preview</h2>
                            <p style="margin: 8px 0 0 0; font-size: 13px; color: #6a737d;">Review the extracted text before generating the Data Vault model</p>
                        </div>
                        <div style="flex: 1; overflow-y: auto; padding: 20px; background: #f6f8fa;">
                            <pre id="ocrPreviewText" style="white-space: pre-wrap; font-family: monospace; font-size: 13px; line-height: 1.6; background: white; padding: 16px; border-radius: 6px; border: 1px solid #e1e4e8;"></pre>
                        </div>
                        <div style="padding: 20px; border-top: 1px solid #e1e4e8; display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeOcrPreview()" class="btn btn-secondary" style="width: auto;">Cancel</button>
                            <button onclick="confirmOcrAndGenerate()" class="btn btn-primary" style="width: auto;">‚úì Looks Good - Proceed to Generate</button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>üß† 3. Generate DV Model</h2>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="groundedMode">
                        Use Knowledge-Grounded Mode
                    </label>
                </div>
                <button onclick="generateModel()" class="btn btn-primary" id="generateBtn" disabled>
                    Generate Data Vault 2.1
                </button>
                <div id="generateStatus"></div>
            </section>

            <section class="section">
                <h2>üìä Model Summary</h2>
                <div class="model-stats" id="modelStats">
                    <div class="stat-item">
                        <span class="stat-value" id="hubCount">0</span>
                        <span class="stat-label">Hubs</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="linkCount">0</span>
                        <span class="stat-label">Links</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="satCount">0</span>
                        <span class="stat-label">Satellites</span>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>üíæ 4. Export Model</h2>
                <button onclick="exportJSON()" class="btn btn-secondary">Export JSON</button>
                <button onclick="exportCSV()" class="btn btn-secondary">Export CSV</button>
                <button onclick="exportDrawIO()" class="btn btn-secondary">Export Draw.io XML</button>
            </section>
        </aside>

        <main class="canvas-area">
            <div class="canvas-controls">
                <button onclick="resetLayout()" class="btn-icon" title="Reset Layout">üîÑ</button>
                <button onclick="fitToScreen()" class="btn-icon" title="Fit to Screen">‚ä°</button>
                <button onclick="zoomIn()" class="btn-icon" title="Zoom In">‚ûï</button>
                <button onclick="zoomOut()" class="btn-icon" title="Zoom Out">‚ûñ</button>
            </div>

            <div class="legend">
                <h3>Legend</h3>
                <div class="legend-item">
                    <div class="legend-color hub"></div>
                    <span>Hub (Business Keys)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color link"></div>
                    <span>Link (Relationships)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color satellite"></div>
                    <span>Satellite (Attributes)</span>
                </div>
            </div>

            <div id="cy"></div>
        </main>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
